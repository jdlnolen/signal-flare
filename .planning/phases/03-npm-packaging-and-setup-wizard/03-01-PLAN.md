---
phase: 03-npm-packaging-and-setup-wizard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsup.config.ts
  - src/cli.ts
  - src/config.ts
autonomous: true
requirements:
  - PKG-01
  - PKG-03
  - PKG-04

must_haves:
  truths:
    - "Running `npx signal-flare` (or the built binary) shows CLI help with setup, test, and status subcommands"
    - "Both MCP server and hook handler load env vars from a .env file when SIGNAL_FLARE_ENV_FILE is set or ~/.config/signal-flare/config.json exists"
    - "No console.log() calls exist anywhere in MCP server or hook handler code paths"
  artifacts:
    - path: "src/cli.ts"
      provides: "CLI entry point with commander subcommands"
      contains: "#!/usr/bin/env node"
    - path: "src/config.ts"
      provides: "dotenv loading from custom path with config.json fallback"
      contains: "dotenv"
    - path: "package.json"
      provides: "Correct bin, files, engines, and new dependencies"
      contains: "dist/cli.js"
    - path: "tsup.config.ts"
      provides: "cli.ts added to entry array"
      contains: "src/cli.ts"
  key_links:
    - from: "package.json"
      to: "dist/cli.js"
      via: "bin field"
      pattern: '"signal-flare".*"./dist/cli.js"'
    - from: "src/config.ts"
      to: "~/.config/signal-flare/config.json"
      via: "resolveEnvFilePath fallback"
      pattern: "config/signal-flare/config.json"
    - from: "src/cli.ts"
      to: "src/commands/"
      via: "commander subcommand imports"
      pattern: "program\\.command"
---

<objective>
Package infrastructure: CLI entry point, dotenv integration, and package.json preparation for global npm install.

Purpose: Establish the foundation that the setup wizard (Plan 02) and README (Plan 03) build on -- correct bin target, new dependencies, dotenv-based config loading, and CLI dispatcher.
Output: Working `signal-flare` CLI binary with help text, dotenv-powered config loading in both server.ts and hook-handler.ts.
</objective>

<execution_context>
@/Users/jdlnolen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdlnolen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-npm-packaging-and-setup-wizard/03-RESEARCH.md

@src/config.ts
@src/server.ts
@src/hook-handler.ts
@package.json
@tsup.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI entry point and update build configuration</name>
  <files>
    src/cli.ts
    package.json
    tsup.config.ts
  </files>
  <action>
1. Install new dependencies:
   ```
   npm install commander @inquirer/prompts dotenv
   ```

2. Create `src/cli.ts` as the CLI binary entry point:
   - Add `#!/usr/bin/env node` shebang comment at top (tsup banner will add the real one)
   - Import `Command` from `commander`
   - Create program with name `signal-flare`, description `Bridge Claude Code and Slack`, version read from a const (hardcode `0.1.0` for now)
   - Add three subcommands: `setup` (description: "Configure Signal Flare for your workspace"), `test` (description: "Send a test notification to Slack"), `status` (description: "Show current configuration and connection status")
   - For now, each command action should be a placeholder that prints a message like `console.log('Setup wizard coming soon...')` -- the real implementations come in Plan 02. NOTE: cli.ts is a CLI process, NOT an MCP server, so console.log() is correct here.
   - Call `program.parse(process.argv)` at the end
   - If no subcommand given, show help: add `program.action(() => program.help())` as default

3. Update `package.json`:
   - Change `"bin"` to `{ "signal-flare": "./dist/cli.js" }` (was `./dist/server.js`)
   - Add `"engines": { "node": ">=18.0.0" }`
   - Update `"files"` to `["dist", "README.md", "LICENSE"]`
   - Add `"license": "MIT"`
   - Verify commander, @inquirer/prompts, and dotenv are in dependencies (npm install should have added them)

4. Update `tsup.config.ts`:
   - Add `"src/cli.ts"` to the `entry` array (alongside existing server.ts, hook-handler.ts, hooks/watcher.ts)

5. Audit for PKG-03 compliance: grep all files in src/ for `console.log(` -- any hits in non-CLI files (server.ts, hook-handler.ts, config.ts, slack/*, hooks/*, tools/*) must be changed to `console.error(`. CLI files (cli.ts, commands/*) are allowed to use console.log since they are user-facing terminal commands, not MCP processes.
  </action>
  <verify>
Run `npm run build` -- should succeed with no errors. Verify `dist/cli.js` exists alongside `dist/server.js`, `dist/hook-handler.js`, `dist/hooks/watcher.js`. Run `node dist/cli.js --help` and confirm it shows the three subcommands (setup, test, status). Run `node dist/cli.js` with no args and confirm it shows help.
  </verify>
  <done>dist/cli.js builds successfully, shows help with setup/test/status subcommands, package.json bin points to dist/cli.js, engines field requires Node >= 18</done>
</task>

<task type="auto">
  <name>Task 2: Add dotenv integration to config loading with convention file fallback</name>
  <files>
    src/config.ts
  </files>
  <action>
1. Update `src/config.ts` to load dotenv before parsing env vars:
   - Import `dotenv` (default import from 'dotenv')
   - Import `existsSync` and `readFileSync` from 'node:fs'
   - Import `path` from 'node:path'
   - Import `homedir` from 'node:os'

2. Add a `resolveEnvFilePath()` function BEFORE the existing `loadConfig()`:
   - First check: if `process.env.SIGNAL_FLARE_ENV_FILE` is set and non-empty, return that path. This is how the MCP server receives the path (via the `env` block in ~/.claude.json).
   - Second check (fallback for hook handlers): read `~/.config/signal-flare/config.json`. If it exists, JSON.parse it and return `cfg.envFile`. Wrap in try/catch, return undefined on any error. Use `path.join(homedir(), '.config', 'signal-flare', 'config.json')`.
   - If neither source provides a path, return undefined (env vars may already be set directly).

3. At the top of `loadConfig()`, before the existing `ConfigSchema.safeParse(process.env)`:
   - Call `resolveEnvFilePath()`
   - If a path is returned AND `existsSync(path)` is true, call `dotenv.config({ path })`
   - If a path is returned but file does NOT exist, log a warning: `console.error('[signal-flare] Warning: .env file not found at ${envFilePath}')`
   - If no path is found, do nothing (fall through to existing env var parsing)

4. Update the error message in loadConfig() when validation fails to include: `"Run \`signal-flare setup\` to configure, or set the env vars manually."` -- this satisfies PKG-04's actionable error requirement.

5. Keep all existing ConfigSchema fields and validation unchanged. The dotenv loading simply populates process.env before the Zod parse runs.
  </action>
  <verify>
Run `npm run build` and `npm run typecheck` -- both succeed. Create a temporary .env file with test values:
```
echo "SLACK_BOT_TOKEN=xoxb-test" > /tmp/sf-test.env
echo "SLACK_CHANNEL_ID=C123" >> /tmp/sf-test.env
```
Run `SIGNAL_FLARE_ENV_FILE=/tmp/sf-test.env node dist/server.js 2>&1 | head -5` -- should attempt to start (may fail on auth.test but should NOT fail on config validation). Clean up: `rm /tmp/sf-test.env`.
  </verify>
  <done>config.ts loads dotenv from SIGNAL_FLARE_ENV_FILE or ~/.config/signal-flare/config.json before Zod parsing; missing env var errors include "Run signal-flare setup" guidance; build and typecheck pass</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with all four entry points (cli, server, hook-handler, watcher)
2. `npm run typecheck` passes
3. `node dist/cli.js --help` shows setup, test, status commands
4. `node dist/cli.js --version` shows 0.1.0
5. `grep -r 'console\.log(' src/ --include='*.ts' | grep -v cli.ts | grep -v commands/` returns no results (PKG-03)
6. package.json has correct bin, engines, files, license fields
</verification>

<success_criteria>
- CLI binary builds and displays help with three subcommands
- dotenv integration loads .env from custom path before config validation
- Hook handler convention file fallback (~/.config/signal-flare/config.json) is implemented
- No console.log() in MCP/hook code paths
- All new dependencies installed and in package.json
</success_criteria>

<output>
After completion, create `.planning/phases/03-npm-packaging-and-setup-wizard/03-01-SUMMARY.md`
</output>
